<!DOCTYPE HTML>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/ui-lightness/jquery-ui.css" media=screen>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/jquery.ui.treemap.js"></script>
        <style type="text/css">
            canvas { border: 1px solid #f00; }
            #treemap { display: inline-block; }
            .highlighter { border: 1px solid #ff0; position: absolute; display: none; pointer-events: none; }
            .mouseoverbox { 
                border: 1px solid #aaa; 
                position: absolute; 
                background-color: #fff; 
                pointer-events: none; 
            }
            .mouseoverbox p {
                margin: 0px;
                padding: 0px;
                font-size: 0.875em;
            }
        </style>
    </head>
    <body>
        <input id="t1" type="button" value="on"/>
        <input id="t2" type="button" value="800x200"/>
        <input id="t3" type="button" value="600x400"/>
        <input id="t4" type="button" value="color1"/>
        <input id="t5" type="button" value="color2"/>
        <input id="t6" type="button" value="gradient1"/>
        <input id="t7" type="button" value="gradient2"/>
        <input id="t8" type="button" value="destroy"/>
        <div id="treemap"></div>
        <div id="debug-info"><span><p>click the 'on' button to create test treemap</p></span></div>
        <div><p><a href="https://github.com/evancarey/jsTreemap">https://github.com/evancarey/jsTreemap</a></p></div>
        <div id="highlighter"></div>
        <div id="mouseoverbox" class="mouseoverbox"></div>
	    <script type="text/javascript">
            var highlighterFadeTimeout;
            var triggerHighlighterFade = function() {
                $("#highlighter").fadeOut(800,"linear");
            };
            var clearHighlighterFade = function() {
                clearTimeout(highlighterFadeTimeout);
            };
            var initHighlighterFade = function(duration) {
                highlighterFadeTimeout = setTimeout('triggerHighlighterFade()',duration);
            };
            var mouseoverboxFadeTimeout;
            var triggerMouseoverboxFade = function() {
                $("#mouseoverbox").fadeOut(800,"linear");
            };
            var clearMouseoverboxFade = function() {
                clearTimeout(mouseoverboxFadeTimeout);
            };
            var initMouseoverboxFade = function(duration) {
                mouseoverboxFadeTimeout = setTimeout('triggerMouseoverboxFade()',duration);
            };
            var mouseclickHandler = function(e,data) {
                var nodes = data.nodes;
                var ids = data.ids;
                alert('you clicked '+nodes[0].label);
            };
            var mousemoveHandler = function(e,data) {
                $("#debug-info").html("<span><p>" + e.pageX + ", " + e.pageY + "; id = " + data.ids[0] + "; label = " + data.nodes[0].label + "</p></span>");
                updateHighlighter(e,data);
                updateMouseoverbox(e,data);
            };
            var updateHighlighter = function(e,data) {
                $(".highlighter").hide().css("background-color","");
                for (var i = 0; i < data.nodes.length-1; i++) {
                    var offset = $("#treemap").offset();
                    var divId = "highlighter"+i;
                    if ( $("#"+divId).length == 0 ) {
                        $("#highlighter").append("<div id=\""+divId+"\" class=\"highlighter\"></div>");
                    }
                    $("#"+divId).css({
                        "display":"inline",
                        "left":data.nodes[i].geometry[0]+offset.left,
                        "top":data.nodes[i].geometry[1]+offset.top,
                        "width":data.nodes[i].geometry[2],
                        "height":data.nodes[i].geometry[3]
                    });
                    /*if (data.nodes[i].hasOwnProperty('children') === false) {
                        var rgb = data.nodes[i].computedColor;
                        $("#"+divId).css("background-color","rgba("+rgb[0]+","+rgb[1]+","+rgb[2]+",0.0)");
                    }*/
                    $("#"+divId).show();
                }
                if (highlighterFadeTimeout != undefined) clearHighlighterFade();
                initHighlighterFade(3000);
                $("#highlighter").show();
            };
            var updateMouseoverbox = function(e,data) {
                $(".mouseoverbox").hide();
                if (data.nodes[0].hasOwnProperty('children') === false) {
                    $("#mouseoverbox").css({"background-color":"#fff"});
                } else {
                    $("#mouseoverbox").css({"background-color":"#ffd"});
                }
                $("#mouseoverbox").html("<span><p>" + e.pageX + ", " + e.pageY + "; id = " + data.ids[0] + "; label = " + data.nodes[0].label + "</p></span>");
                var mouseoverboxWidth = $("#mouseoverbox").width();
                var mouseoverboxHeight = $("#mouseoverbox").height();
                var treemapWidth = $("#treemap").width();
                var treemapHeight = $("#treemap").height();
                var treemapOffset = $("#treemap").offset();
                if (e.pageX + mouseoverboxWidth > treemapOffset.left + treemapWidth) {
                    $("#mouseoverbox").css({ "left":e.pageX-mouseoverboxWidth-8 });
                } else {
                    $("#mouseoverbox").css({ "left":e.pageX+16 });
                }
                if (e.pageY + mouseoverboxHeight > treemapOffset.top + treemapHeight) {
                    $("#mouseoverbox").css({ "top":e.pageY-mouseoverboxHeight });
                } else {
                    $("#mouseoverbox").css({ "top":e.pageY });
                }
                if (mouseoverboxFadeTimeout != undefined) clearMouseoverboxFade();
                initMouseoverboxFade(3000);
                $("#mouseoverbox").show();
            };
            var init = function(){
                $("#t1").click(function(){
                    $("#debug-info").html("<span><p>0,0</p></span>");
                    $("#treemap").treemap()
                    .bind('treemapmousemove',mousemoveHandler)
                    .bind('treemapclick',mouseclickHandler);
                });
                $("#t2").click(function(){
                    $(".highlighter").hide();
                    $("#treemap").unbind()
                    .treemap("option","dimensions",[800,200])
                    .bind('treemapmousemove',mousemoveHandler)
                    .bind('treemapclick',mouseclickHandler);
                });
                $("#t3").click(function(){
                    $(".highlighter").hide().unbind();
                    $("#treemap").unbind()
                    .treemap("option","dimensions",[600,400])
                    .bind('treemapmousemove',mousemoveHandler)
                    .bind('treemapclick',mouseclickHandler);
                });
                $("#t5").click(function(){
                    $("#treemap").treemap("option","colorGradient",{
                        resolution:1024,
                        colorStops:[
                            {"val":0,  "color":"#a00"},
                            {"val":.4,"color":"#f00"},
                            {"val":.5, "color":"#fff"},
                            {"val":.6,"color":"#0f0"},
                            {"val":1,  "color":"#070"}
                        ]
                    });
                });
                $("#t4").click(function(){
                    $("#treemap").treemap("option","colorGradient",{
                        resolution:1024,
                        colorStops:[
                            {"val":0,"color":"#770"},
                            {"val":0.5,"color":"#fff"},
                            {"val":1,"color":"#077"}
                        ]
                    });
                });
                $("#t6").click(function(){
                    $("#treemap").treemap("option","nodeGradient",function(ctx,rect,rgb){
                        var r1 = Math.min(rect[2],rect[3])*0.1;
                        var r2 = Math.max(rect[2],rect[3]);
                        var x = rect[0]+rect[2]*0.5;
                        var y = rect[1]+rect[3]*0.5;
                        var gradient = ctx.createRadialGradient(x,y,r1,x,y,r2);
                        gradient.addColorStop(0,TreemapUtils.lighterColor(TreemapUtils.rgb2hex(rgb),0.2));
                        gradient.addColorStop(1,TreemapUtils.darkerColor(TreemapUtils.rgb2hex(rgb),0.2));
                        return gradient;
                    })
                });
                $("#t7").click(function(){
                    $("#treemap").treemap("option","nodeGradient",function(ctx,rect,rgb){
                        var min = Math.min(rect[2],rect[3]);
                        var gradient = ctx.createLinearGradient(rect[0]+rect[2]-min,rect[1]+rect[3]-min,rect[0]+rect[2],rect[1]+rect[3]);
                        gradient.addColorStop(0,TreemapUtils.rgb2hex(rgb));
                        gradient.addColorStop(0.7,TreemapUtils.rgb2hex(rgb));
                        gradient.addColorStop(1,TreemapUtils.darkerColor(TreemapUtils.rgb2hex(rgb),0.2));
                        return gradient;
                    })
                });
                $("#t8").click(function(){
                    $(".highlighter").hide().unbind();
                    $("#treemap").unbind().treemap("destroy");
                    $("#debug-info").html("<span><p>click the on button to create treemap</p></span>");
                });
            };
            $(document).ready(function(){
                        init();
            });
        </script>
    </body>
</html>

